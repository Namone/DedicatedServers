apiVersion: apps/v1
kind: Deployment
metadata:
    name: dedicated-server
    namespace: servers
spec:
    selector:
        matchLabels:
            app: dedicated-server
    template:
        metadata:
            labels:
                app: dedicated-server
        spec:
            # volumes:
              # - name: persistent-storage
              #   # This AWS EFS volume must already exist.
              #   persistentVolumeClaim:
              #     claimName: efs-claim
            volumes:  
              - name: pz-game-data
                persistentVolumeClaim:
                  claimName: pz-storage-1
              - name: pz-save-data
                persistentVolumeClaim:
                  claimName: pz-storage-2
              - name: val-game-data
                persistentVolumeClaim:
                  claimName: val-storage-1
              - name: val-save-data
                persistentVolumeClaim:
                  claimName: val-storage-2
              - name: baro-game-data
                persistentVolumeClaim:
                  claimName: baro-storage-1
              - name: baro-save-data
                persistentVolumeClaim:
                  claimName: baro-storage-2
            initContainers:
                - name: init-zomboid
                  image: {{ .Values.zomboidImage }}
                  command: ["/usr/games/steamcmd", "+force_install_dir", "/zomboid", "+login", "anonymous", "+app_update", "380870", "validate", "+quit"]
                  volumeMounts:
                    - mountPath: /zomboid
                      name: pz-game-data
                - name: init-pz-script
                  image: {{ .Values.zomboidImage }}
                  command: ["mv", "/internal/start-zomboid-server.sh", "/zomboid/start-zomboid-server.sh"]
                  volumeMounts:
                    - mountPath: /zomboid
                      name: pz-game-data
                # - name: init-pz-world
                #   image: {{ .Values.zomboidImage }}
                #   command: ["cp", "-rf", "/internal/Zomboid", "/root"]
                #   volumeMounts:
                #     - mountPath: /root/Zomboid
                #       name: pz-save-data
                - name: init-valheim
                  image: {{ .Values.valheimImage }}
                  command: ["/usr/games/steamcmd", "+force_install_dir", "/valheim", "+login", "anonymous", "+app_update", "896660", "validate", "+quit"]
                  volumeMounts:
                    - mountPath: /valheim
                      name: val-game-data
                - name: init-val-script
                  image: {{ .Values.valheimImage }}
                  command: ["mv", "/internal/start-valheim-server.sh", "/valheim/start-valheim-server.sh"]
                  volumeMounts:
                    - mountPath: /valheim
                      name: val-game-data
                - name: init-baro-script
                  image: {{ .Values.barotraumaImage }}
                  command: ["mv", "/internal/Barotrauma/entry.sh", "/barotrauma/entry.sh"]
                  volumeMounts:
                    - mountPath: /barotrauma
                      name: baro-game-data
                - name: init-baro-config
                  image: {{ .Values.barotraumaImage }}
                  command: ["mv", "/internal/Barotrauma/serversettings.xml", "/barotrauma/serversettings.xml"]
                  volumeMounts:
                    - mountPath: /barotrauma
                      name: baro-game-data
                - name: init-baro-perms
                  image: {{ .Values.barotraumaImage }}
                  command: ["mv", "/internal/Barotrauma/Data/clientpermissions.xml", "/barotrauma/clientpermissions.xml"]
                  volumeMounts:
                    - mountPath: /barotrauma
                      name: baro-game-data
                # - name: init-baro-saves
                #   image: {{ .Values.barotraumaImage }}
                #   command: ["cp", "-rf", "/internal/Barotrauma/Multiplayer", "/barotrauma/Daedalic Entertainment GmbH/Barotrauma"]
                #   volumeMounts:
                #     - mountPath: /barotrauma
                #       name: baro-game-data
                - name: init-baro-data
                  image: {{ .Values.barotraumaImage }}
                  command: ["cp", "-rf", "/internal/Barotrauma/Data", "/barotrauma"]
                  volumeMounts:
                    - mountPath: /barotrauma
                      name: baro-game-data
            containers:
                - name: barotrauma
                  image: {{ .Values.barotraumaImage }}
                  imagePullPolicy: Always
                  env:
                    - name: STEAMAPPDIR
                      value: "/barotrauma"
                  ports:
                    - name: baro-server
                      protocol: UDP
                      containerPort: 27015
                    - name: baro-server-q
                      protocol: UDP
                      containerPort: 27016
                  resources:
                      limits:
                        cpu: "2"
                        memory: 4Gi
                        ephemeral-storage: 16Gi
                      requests:
                        cpu: "1"
                        memory: 2Gi
                        ephemeral-storage: 8Gi
                  volumeMounts:
                    - name: baro-game-data
                      mountPath: /barotrauma
                    - name: baro-save-data
                      mountPath: /home/steam
                - name: zomboid
                  image: {{ .Values.zomboidImage }}
                  imagePullPolicy: Always
                  command:
                    # - "sleep"
                    # - "100000"
                    - "./start-server.sh"
                    - "-servername"
                    - "zomboid"
                    - "-adminpassword"
                    - "Muggins1"
                  ports:
                    - name: zomboid-server
                      protocol: UDP
                      containerPort: 16261
                    - name: zomb-server-q
                      protocol: UDP
                      containerPort: 16262
                  resources:
                      limits:
                        cpu: "2"
                        memory: 8Gi
                        ephemeral-storage: 16Gi
                      requests:
                        cpu: "1"
                        memory: 2Gi
                        ephemeral-storage: 8Gi
                  volumeMounts:
                    - name: pz-game-data
                      mountPath: /zomboid
                    - name: pz-save-data
                      mountPath: /root/Zomboid
                - name: valheim
                  image: {{ .Values.valheimImage }}
                  imagePullPolicy: Always
                  command:
                    - "/bin/bash"
                    - "./start-valheim-server.sh"
                  ports:
                    - name: valheim-server
                      protocol: UDP
                      containerPort: 2456
                    - name: val-server-q
                      protocol: UDP
                      containerPort: 2457
                  resources:
                      limits:
                        cpu: "2"
                        memory: 4Gi
                        ephemeral-storage: 8Gi
                      requests:
                        cpu: "1"
                        memory: 2Gi
                        ephemeral-storage: 2Gi
                  volumeMounts:
                    - name: val-game-data
                      mountPath: /valheim
                    - name: val-save-data
                      mountPath: /root/.config
              